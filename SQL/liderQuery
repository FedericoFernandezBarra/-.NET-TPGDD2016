CREATE procedure XXX.st_insertar_afiliado

@nro_grupo_familiar char(4),
@estado_civil numeric(10,0),
@plan_medico numeric(10,0),
@cantidad_hijos smallint,
@nombre  nvarchar(255),
@apellido    nvarchar(255),
@tipo_documento  numeric(10,0),  
@documento   nvarchar(12),
@fecha_nacimiento    date,
@direccion   nvarchar(255),
@telefono    nvarchar(255),
@mail    nvarchar(255),
@sexo    char,

@error varchar(3) output
AS
begin
     declare @idUsuario numeric(10,0)
	 declare @id_numerito numeric(10,0)
	 set @error = 't'
	 BEGIN TRANSACTION  
     BEGIN TRY

	  if(@nro_grupo_familiar='01')
	  begin
	       insert into XXX.NUMERITOS(algo)
	       values ('p')
	       select @id_numerito =max(id_numerito) from XXX.NUMERITOS
		   select @idUsuario =  Concat(@id_numerito,@nro_grupo_familiar)
		   PRINT @idUsuario
	  end

	  if(@nro_grupo_familiar<>'01')
	  begin
	       select @id_numerito =max(id_numerito) from XXX.NUMERITOS
		   select @idUsuario =  Concat(@id_numerito,@nro_grupo_familiar)
	  end
	  PRINT @idUsuario
	 
	 	insert into XXX.USUARIO(id_usuario,nick,pass,intentos_login,activo,nombre,apellido,tipo_documento,
				documento,fecha_nacimiento,direccion,telefono,mail,sexo
					   )
	    values (@idUsuario,@documento,'pass',0,1,@nombre,@apellido,@tipo_documento,@documento,@fecha_nacimiento,@direccion,
		       @telefono,@mail,@sexo)

		

	insert into XXX.AFILIADO(id_afiliado,nro_grupo_familiar,estado_civil,plan_medico,cantidad_hijos)
	values (@idUsuario,@nro_grupo_familiar,@estado_civil,@plan_medico,@cantidad_hijos)

	 COMMIT TRAN  
     END TRY 
     BEGIN CATCH  
     ROLLBACK TRAN 
     set @error = 'e'
     END CATCH 

end

go

go

go

create procedure XXX.st_buscar_afiliados
@nro_raiz numeric(10,0),
@nro_grupo_familiar numeric(10,0)

AS
begin

      select *
      from XXX.USUARIO
      inner join XXX.AFILIADO on id_usuario = id_afiliado
	  where (nro_raiz = @nro_raiz OR @nro_raiz IS NULL) and
	  (nro_grupo_familiar = @nro_grupo_familiar OR @nro_grupo_familiar IS NULL)

end

go

create procedure XXX.st_baja_afiliado
@nro_raiz numeric(10,0),
@nro_grupo_familiar numeric(10,0),
@fecha_baja date

AS
begin

	 update XXX.AFILIADO SET baja_logica = 1, fecha_baja=@fecha_baja 
	 where nro_raiz = @nro_raiz and nro_grupo_familiar=@nro_grupo_familiar

end
